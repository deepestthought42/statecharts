(in-package #:statecharts)

;;; 


(defun %register-event (statechart event-name transition-object)
  (let+ (((&slots events) statechart)
	 (event (alexandria:if-let (existing (gethash event-name events))
		  existing
		  (setf (gethash event-name events)
			(make-instance 'event :name event-name)))))
    (push transition-object (registered-transitions event))))


(defun %t (initial-key event final-key if)
  (labels ((format-key (key)
	     (cond
	       ((stringp key) key)
	       ((listp key) (format nil "狺藓湖脲┅ㄥ蝌矧⒃栝箬秕熹栳痧孱┅┅磲脲轭篝犷沐趄犷箝糸镱侯犴ㄦ矧磲铋幄ㄦ矧磲舡脲轭轸獒飙脲ㄦ矧磲舡脲骈钺飙脲┅哄鲥铘弼孱洪铋糸犰篝狒轭轸獒飙脲烘轭犰篝狒骈钺飙脲虹踽蜾ㄩ殒殒ㄣ镱篝犷綮舂┅┅ㄤ彐躅ン钺礤溴筱蜷痿轱孱趄屮轸箦戾泗矧磲脲轭篝犷沐篝狒侯犴钺礤轰弩泸轲糸镱溴筱蜷痿轱猴瞽孱趄ㄩ孱趄孱趄ㄣ镱篝犷綮舂后屐邈麸箦戾泗矧猴瞽屮轸ㄩ屮轸屮轸ㄣ镱篝犷綮舂┅ㄤ彐躅ヤ弪彐弪孱沐脲篚疱蝮翎翦脲灬忮祗è鲠扉洵溴筱蜷痿矧ㄤ弩悌躅戾篌篝蜷铉溴筱ㄥ蝌矧ч铞犰殇篝狒瀛溴筱蜷痿矧轰弩泸轲麸溴筱┅┅ㄣ镱换ǒ⒘⒙⒚蝈驽蝈钽弩鏖翳蝈箴邈麸翳蝻雉镦翳趄邋换⒚鏖翳轭⒙鏖翳轭⒘è犷扉篝脲ㄥ聃犰Нㄦ轵篝脲┅磲疸狎＇鲠扉洵溴筱蜷痿矧ㄣ潋脲┅ㄣ潋脲┅换á立⒙蝈驽蝈钽弩鏖翳轭翳沲蝌孱篚疱篝狒搴换⒙鏖翳轭⒘鏖翳轭翳沲蝌孱篚疱蝮翎翦è犷扉篝脲磲疸狎＇鲠扉洵溴筱蜷痿矧脲矧ㄥ聃犰铋篚疱蝮翎翦磲疸狎＇鲠扉洵溴筱蜷痿矧篚疱蝮翎翦┅ㄡ痧孱篚疱蝮翎翦脲┅换⒘蝈驽蝈钽弩⒘鏖翳轭翳沲蝌孱篚疱蝮翎翦è篝蜷铉脲ㄡ痧孱篚疱蝮翎翦扉篝脲┅ㄥ蝌矧ч铞犰殇篝狒瀛溴筱蜷痿矧轰弩泸轲麸脲┅┅ㄤ彐躅ヲ彗轶翦颦篝狒篝狒邈栳螋篚疱蝮翎翦篝狒瀛钺礤篝狒瀛镡赍泗戾臬èé箪雉篝狒弩篝狒邈栳螋脲ē溴蝈驽蝈钽瀛脲篚疱蝮翎翦篝狒瀛钺礤┅ㄥ轶糸铉ㄧ弭栳箬脲篝狒弩┅ㄩ屮轶糸铉ㄥ蝌矧篝狒瀛屮轶趔弘妁脲┅箦翩ㄧ弭栳箬脲篝狒弩篝狒瀛镡赍泗篝狒瀛镡赍泗┅ㄤ彐躅ヲ彗轶翦颦趄犷箝糸镱篝狒邈栳螋轭轸獒飙脲骈钺飙脲趄犷箝糸镱镡赍泗戾臬èé箪雉趄犷箝糸镱螬篝狒邈栳螋脲ㄡ痧孱轭轸獒飙脲骈钺飙脲┅ㄥ轶糸铉ㄧ弭栳箬脲趄犷箝糸镱螬┅ㄩ屮轶糸铉ㄥ蝌矧趄犷箝糸镱屮轶趔弘妁脲┅箦翩ㄧ弭栳箬脲趄犷箝糸镱螬趄犷箝糸镱镡赍泗┅趄犷箝糸镱镡赍泗ㄤ彐躅ャ桢汶溴骟翎翦汨狎舡狎珲礤铘钺礤溴筱蜷痿轱溴骈铋糸镱螬ㄤ邈灬蝈ㄩ珙矧溴骈铋糸镱螬ㄣ镱è铒簌礅镬钺礤┅ㄥ蝌矧ч铞犰殇汨狎舡簌铘狲喉弩筢珏⑽犴铄邃麸忮簌礅镬猴骀孱溟铉泔溴钺礤┅è铒篝蜷铉溴筱蜷痿轱瞟ㄥ蝌矧ч铞犰殇汨狎舡簌铘狲喉弩筢珏⒛弩泸轲糸镱铄邃麸忮篝蜷铉猴骀孱溟铉泔溴溴筱蜷痿轱瞟┅换换桢祓弪磲泸矬ㄤ彐磲泸鏖翳铄鳝篚疱蝮翎翦钺礤怙澌怙澌啜戾è篚疱蝮翎翦脲ㄡ痧孱篚疱蝮翎翦脲扉篝钺礤┅┅痱镧棱镤┅ㄤ彐磲泸鏖翳铄鳝箦戾泗矧钺礤豉疱怙澌怙澌啜戾舄è沲蝌孱舡箦戾泗矧磲脲轭篝犷沐К豉疱后屐邈翦洵篝狒钺礤┅痱镧棱镤┅ㄤ彐磲泸ン躔弪篝狒豉疱钺礤篝狒瀛箦戾泗矧溴驷蹯舡篝狒溴筱蜷痿轱孱趄屮轸篚猸篝狒弩啜篝狒瀛箦戾泗矧溴驷蹯舡篝狒篝狒邈栳螋蠛亥蝈玳篝弪篝狒篝狒邈栳螋篚疱蝮翎翦脲钺礤鏖翳铄鳝篚疱蝮翎翦钺礤磲脲轭篝犷沐К豉疱侯犴钺礤轰弩泸轲糸镱溴筱蜷痿轱猴瞽孱趄ㄩ孱趄孱趄ㄣ镱篝犷綮舂猴瞽屮轸ㄩ屮轸屮轸ㄣ镱篝犷綮舂后屐邈麸沲蝌孱舡箦戾泗矧哄戾礤铘扉篝荔踱篝狒弩┅┅┅换篝狒邈栳螋溴骈铋糸镱灬铉踽珏ㄤ彐磲泸ㄥ鲥铘轭轸獒骈钺脲殒⑶轹孱弼孱鏖翳钺礤胖盼袁泔铙趄蹉犷镡赍泗镦豉疱砸廖由陨衔骝镯轭轸獒篝狒鏖翳钺礤晌稍闪麸骈钺篝狒鏖翳钺礤粕瘟坍涉善轶铒瞽铋飕轸轶狍篚礤麸忮骢钽糸镱镦镱疳蜥礤翦颥翳篝狒邈栳螋盼稚蚁瓮盼犷翳趄犷箝糸镱鏖祆镱禊痱镢邋殒善蝈趱蝾趄蹂浇砸廖由陨衔啜戾舄è轭轸獒飙脲篝狒邈栳螋蠛亥溴蝈驽蝈钽瀛脲篚疱蝮翎翦脲轭轸獒飑ㄦ轭犰脲篝狒邈栳螋蠛亥溴蝈驽蝈钽瀛脲篚疱蝮翎翦脲骈钺飑趄犷蟓镡篝狒邈栳螋蠛亥轭轸獒飙脲弼孱骈钺飙脲殒┅篝狒邈栳螋蠛亥蝈玳篝弪弼孱篝狒邈栳螋弼孱趄犷蟓镡戛篝狒邈栳螋蠛亥蝈玳篝弪趄犷箝糸镱篝狒邈栳螋轭轸獒飙脲骈钺飙脲趄犷蟓镡戛┅ㄤ彐磲泸ㄤ彐狨祠篝狒怙澌怙澌⒁弭躜铙犷镡赍泗镦豉疱呐屏仗原优膛迷弦翳狒箦戾泗翳篝狒鏖翳钺礤呐屏仗原釉猎浇呐屏仗原优膛迷弦啜鏖翳铄鳝箦戾泗矧溴驷蹯舡篝狒篝狒邈栳螋蠛轰彐狨祠箦戾泗矧棱镤┅ㄤ彐磲泸ㄩ铋糸犰篝狒怙澌怙澌⒁弭躜铙犷镡赍泗镦豉疱壬釉弦侪优膛迷弦翳狒脲屦蝈泔蜾犷箦戾泗翳灬篝蝈泔蜾邃篝狒躔镱孱趄震镱骈蝮孱趄翳篝狒鏖钺礤晌稍闪汰釉猎鏖祆忮箦戾泗邃浇壬釉弦侪优膛迷弦啜鏖翳铄鳝箦戾泗矧轭轸獒飙篝狒篝狒邈栳螋蠛鸿轶麸蝙箦戾泗矧棱镤┅ㄤ彐磲泸钺礤篝狒瀛箦戾泗矧溴驷蹯舡篝狒脲ㄤ弩泸轲糸镱孱趄屮轸怙澌篚猸篝狒弩⒁弭躜铙犷镡赍泗镦豉疱弦匀锨衔撂鏖翳轸篚猸篝狒弩忮轭徙糸鲥狒翳筢礤糸礤楫瀹祜玳汜泔铌躅泗轱镦翳篚猸篝狒弩熄帘廖帘敛廖鏖翳翳钺礤瘟团翳狒鏖祆栳鲥诱颅釉猎庞狍轸篚猸篝狒弩澡轭轸獒篝狒鏖祆忮汨镲箦怡釉猎怒优膛迷弦犷呐屏仗原釉猎女轴扉簌礅镬骘釉猎怒优膛迷弦狎ㄦ矧溴驷蹯舂犷ㄦ矧栝篝矧┊呐用疑性上轶犷镳糸镱犰屮痨犷狒轱骘翳矧翳镧镱犰沆躞翦虍涉玳鲥翳骢钽糸镱盼砸鏖祆忮汜祆邃躔镱篝狒瀛汨犷珏轭麸翳篝狒瘟团犷咆稍鏖祆忮汜祆邃躔镱篝狒瀛汨犷珏秕镦翳篝狒瘟团咆稍犷盼砸骢钽糸镱镦镱鲠蜷徕戾犷鏖祆忮汜祆邃鏖翳翳盼稚蚁瓮盼狍翳彘疳蜥礤翦虍骄弦匀锨衔撂啜ン躔弪篝狒矧梏镧镱犰钺礤篝狒瀛箦戾泗矧溴驷蹯舡篝狒溴筱蜷痿轱孱趄屮轸篚猸篝狒弩┅ㄤ彐磲泸钺礤篝狒瀛箦戾泗矧溴驷蹯舡篝狒脲ㄤ弩泸轲糸镱孱趄屮轸怙澌篚猸篝狒弩⒁弭躜铙犷镡赍泗镦豉疱锰沼耘鏖翳镱禊镱篚猸篝狒忮轭徙糸鲥狒犰糸礤蟋楫瀹祜玳汜泔铌躅泗轱镦翳篚猸篝狒弩熄帘廖帘敛廖鏖翳翳钺礤瘟团翳狒鏖祆栳鲥诱颅釉猎庞狍轸篚猸篝狒弩澡轭轸獒篝狒鏖祆忮汨镲箦怡釉猎怒优膛迷弦犷呐屏仗原釉猎女轴扉簌礅镬骘釉猎怒优膛迷弦狎ㄦ矧溴驷蹯舂犷ㄦ矧栝篝矧┊呐用疑性上轶犷镳糸镱犰屮痨犷狒轱骘翳矧翳镧镱犰沆躞翦虍涉玳鲥翳骢钽糸镱盼砸鏖祆忮汜祆邃躔镱篝狒瀛汨犷珏轭麸翳篝狒瘟团犷咆稍鏖祆忮汜祆邃躔镱篝狒瀛汨犷珏秕镦翳篝狒瘟团咆稍犷盼砸骢钽糸镱镦镱鲠蜷徕戾犷鏖祆忮汜祆邃鏖翳翳盼稚蚁瓮盼狍翳彘疳蜥礤翦虍骄锰沼耘尧啜ン躔弪篝狒沆躞翦钺礤篝狒瀛箦戾泗矧溴驷蹯舡篝狒溴筱蜷痿轱孱趄屮轸篚猸篝狒弩┅ㄤ彐磲泸钺礤脲ㄤ弩泸轲糸镱孱趄屮轸⒁弭躜铙犷镡赍泗镦豉疱釉猎鏖翳翳钺礤瘟团呐用疑性上轶犷镳糸镱犰屮痨犷狒轱骘翳矧翳镧镱犰沆躞翦虍涉玳鲥翳骢钽糸镱盼砸鏖祆忮汜祆邃躔镱篝狒瀛汨犷珏轭麸翳篝狒瘟团犷咆稍鏖祆忮汜祆邃躔镱篝狒瀛汨犷珏秕镦翳篝狒瘟团咆稍犷盼砸骢钽糸镱镦镱鲠蜷徕戾犷鏖祆忮汜祆邃鏖翳翳盼稚蚁瓮盼狍翳彘疳蜥礤翦虍骄釉猎泞啜篝狒邈栳螋蠛亥蝈玳篝弪篝狒篝狒邈栳螋篚疱蝮翎翦脲钺礤篝狒邈栳螋蠛亥钺礤溴筱蜷痿轱孱趄屮轸沲蝌孱舡箦戾泗矧┅ㄤ彐磲泸溴骟翎翦汨狎è钺礤脲ㄤ弩泸轲糸镱┅怙澌溴骈铋糸镱螬ē汨邈氕溴骟翎翦汨狎舡狎珲礤铘钺礤溴筱蜷痿轱溴骈铋糸镱螬啜戾舄è篝狒邈栳螋磲脲轭篝犷沐篝狒邈栳螋蠛后翎翦汨狎侯犴篝蜷铉钺礤轰弩泸轲糸镱溴筱蜷痿轱瞟篚疱蝮翎翦脲Ж┅ㄣ躜蝈铘箦戾泗矧┅痱镧冷彐轭轸轱铙ㄤ彐疳蜥礤翦钺礤篝狒邈栳螋篝狒邈栳螋┅